#!/bin/bash

# gitvis - Git Visit: Run git commands on root repo and all submodules
# Usage: gitvis <git-command-args>
# Example: gitvis status
# Example: gitvis remote -v

# Default to "status" if no arguments provided
if [ $# -eq 0 ]; then
    set -- "status"
fi

# Validate that only permitted commands are used
case "$1" in
    "status"|"remote")
        ;;
    *)
        echo "Error: Only 'status' and 'remote' commands are permitted"
        echo "Usage: gitvis status"
        echo "Usage: gitvis remote -v"
        exit 1
        ;;
esac

# Function to run git command in a directory
run_git_command() {
    local dir="$1"
    local display_name="$2"
    
    echo "=== $display_name ==="
    if [ -d "$dir" ]; then
        cd "$dir" || exit 1
        git "$@"
        echo
    else
        echo "Directory not found: $dir"
        echo
    fi
}

# Store the original directory
ORIGINAL_DIR=$(pwd)

# Run command on root repository
run_git_command "$ORIGINAL_DIR" "Root Repository" "$@"

# Run command on each submodule
for submodule in $(git submodule foreach --quiet 'echo $path'); do
    submodule_path="$ORIGINAL_DIR/$submodule"
    run_git_command "$submodule_path" "Submodule: $submodule" "$@"
done

# Return to original directory
cd "$ORIGINAL_DIR"